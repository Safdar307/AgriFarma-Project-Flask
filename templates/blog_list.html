{% extends "base.html" %}

{% block title %}Our Blogs - AgriFarma{% endblock %}

{% block content %}
<style>
    :root {
        --primary-green: #198754;
        --accent: #20c997;
        --glass: rgba(255, 255, 255, 0.8);
        --glass-border: rgba(25, 135, 84, 0.15);
    }
    .blog-hero {
        background: linear-gradient(135deg, var(--primary-green), var(--accent));
        color: #fff;
        padding: 56px 0;
        border-radius: 12px;
    }
    .search-pane {
        background: var(--glass);
        backdrop-filter: blur(6px);
        border: 1px solid var(--glass-border);
        border-radius: 14px;
        padding: 18px;
    }
    .posts-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
    }
    @media (max-width: 992px) {
        .posts-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    @media (max-width: 768px) {
        .posts-grid {
            grid-template-columns: 1fr;
        }
    }
    .post-card {
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: 14px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform .25s, box-shadow .25s;
    }
    .post-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 18px 40px rgba(25, 135, 84, 0.12);
    }
    .post-media {
        height: 220px;
        overflow: hidden;
        background: #eaf9f0;
    }
    .post-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .category-pill {
        position: absolute;
        left: 14px;
        top: 14px;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 700;
        font-size: .78rem;
    }
    .post-body {
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .meta-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: .9rem;
        color: #4b5258;
    }
    .counts {
        display: inline-flex;
        gap: 12px;
        align-items: center;
        color: #3b3f41;
    }
    .btn-read {
        background: linear-gradient(90deg, var(--primary-green), var(--accent));
        color: #fff;
        padding: 8px 12px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 700;
    }
</style>

<div class="container my-4">
  <div class="blog-hero px-3">
    <div class="container text-center">
      <h1 class="fw-bold">üåø Our Blogs</h1>
      <p class="lead mb-0">Actionable farming advice, research-backed articles, and stories from the field.</p>
      <div class="mt-3">
        <a href="{{ url_for('blog.create') }}" class="btn btn-light btn-lg fw-bold">
          <i class="bi bi-pencil-square me-2"></i>Create Blog Post
        </a>
      </div>
    </div>
  </div>

  <div class="my-4">
    <div class="search-pane mb-4">
      <form method="get" action="{{ url_for('blog.blog_list') }}">
        <div class="row g-2 align-items-center">
          <div class="col-md-6">
            <input name="q" value="{{ q|default('') }}" class="form-control" placeholder="Search by title, body or tags..." />
          </div>
          <div class="col-md-4">
            <select name="cat" class="form-select">
              <option value="">All categories</option>
              {% for c in categories %}
              <option value="{{ c.id }}" {% if cat and cat == c.id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-success">Filter</button>
          </div>
        </div>
      </form>
    </div>

    <div class="posts-grid">
      {% if posts %}
        {% for post in posts %}
        <article class="post-card">
          <div class="position-relative post-media">
            {% set first_media = post.media[0] if post.media and post.media|length > 0 else None %}
            {% if first_media and first_media.media_type == 'image' %}
              <img src="{{ url_for('static', filename=first_media.file_path) }}" alt="{{ post.title }}">
            {% else %}
              <img src="{{ url_for('static', filename='images/dan-meyers-IQVFVH0ajag-unsplash.jpg') }}" alt="{{ post.title }}">
            {% endif %}
            <span class="category-pill">{{ post.category or 'Uncategorized' }}</span>
          </div>
          <div class="post-body">
            <div>
              <h3 class="h5 mb-1">
                <a href="{{ url_for('blog.blog_post', post_id=post.id) }}" class="text-decoration-none text-dark">{{ post.title }}</a>
              </h3>
              <p class="text-muted small mb-1">
                by <strong class="text-success">{{ post.author_name if post.author_name else 'Author' }}</strong> ‚Ä¢
                {{ post.created_at.strftime('%b %d, %Y') if post.created_at else '' }}
              </p>
              <p class="mb-2 text-muted" style="min-height:44px;">
                {{ post.body[:200] ~ ('...' if post.body|length > 200 else '') }}
              </p>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-auto">
              <div class="counts">
                <span class="me-2"><i class="bi bi-chat-left-text"></i> {{ post.comments|length if post.comments is defined else 0 }}</span>
                <button class="btn btn-sm btn-outline-success me-2 like-btn" data-post-id="{{ post.id }}">
                  <i class="bi bi-heart"></i> <span class="like-count">{{ post.likes|length if post.likes is defined else 0 }}</span>
                </button>
              </div>
              <a href="{{ url_for('blog.blog_post', post_id=post.id) }}" class="btn-read">Read</a>
            </div>
          </div>
        </article>
        {% endfor %}
      {% else %}
        <div class="alert alert-info">No posts found.</div>
      {% endif %}
    </div>

    {% if posts and posts.__class__.__name__ == 'Pagination' %}
    <nav aria-label="pagination" class="mt-4">
      <ul class="pagination">
        {% if posts.has_prev %}
        <li class="page-item"><a class="page-link" href="{{ url_for('blog.blog_list', q=q, cat=cat, page=posts.prev_num) }}">‚Üê Prev</a></li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">‚Üê Prev</span></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Page {{ posts.page }} of {{ posts.pages }}</span></li>
        {% if posts.has_next %}
        <li class="page-item"><a class="page-link" href="{{ url_for('blog.blog_list', q=q, cat=cat, page=posts.next_num) }}">Next ‚Üí</a></li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Next ‚Üí</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>

<script>
  (function(){
      const input = document.querySelector('input[name="q"]');
      if(!input) return;
      input.addEventListener('keyup', e=>{
          if(e.key === 'Enter') input.form.submit();
      });
      
      // Like functionality for blog list
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const postId = btn.getAttribute('data-post-id');
          const likeCountSpan = btn.querySelector('.like-count');
          
          btn.disabled = true;
          const originalContent = btn.innerHTML;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
          
          try {
            const response = await fetch(`/blog/like/${postId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              
              if (data.success) {
                likeCountSpan.textContent = data.count;
                
                if (data.action === 'liked') {
                  btn.classList.remove('btn-outline-success');
                  btn.classList.add('btn-success');
                } else {
                  btn.classList.remove('btn-success');
                  btn.classList.add('btn-outline-success');
                }
              } else {
                alert('Error: ' + (data.msg || 'Could not process like'));
              }
            } else if (response.status === 401) {
              alert('Please login to like posts.');
              window.location.href = '/auth/login';
            } else {
              alert('Error processing like request');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Network error. Please try again.');
          } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
          }
        });
      });
  })();
</script>

{% endblock %}

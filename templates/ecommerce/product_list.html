{% extends "base.html" %}
{% block title %}Marketplace - AgriFarma{% endblock %}
{% block content %}
<style>
  /* Only style cards and buttons â€” keep existing page background */
  .product-card {
    border: none !important;
    border-radius: 18px !important;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(6px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 25px rgba(0,0,0,0.2);
  }

  .product-card img {
    border-radius: 18px 18px 0 0;
    object-fit: cover;
  }

  .btn-success {
    background-color: #2d6a4f;
    border: none;
    transition: all 0.3s ease;
  }

  .btn-success:hover {
    background-color: #40916c;
  }

  .btn-outline-success {
    border: 2px solid #2d6a4f;
    color: #2d6a4f;
    transition: all 0.3s ease;
  }

  .btn-outline-success:hover {
    background-color: #2d6a4f;
    color: #fff;
  }

  .form-control, .form-select {
    border-radius: 10px;
    border: 1px solid #cce3de;
    background-color: rgba(255,255,255,0.85);
  }

  .pagination .page-link {
    border-radius: 10px !important;
    color: #2d6a4f;
  }

  .pagination .page-item.active .page-link {
    background-color: #2d6a4f;
    border-color: #2d6a4f;
  }
</style>

<div class="container py-4">
  <div class="mb-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">
      <h2 class="mb-0 text-success fw-bold">Marketplace</h2>
      {% if session.get('user_id') %}
      <a href="{{ url_for('ecommerce.create') }}" class="btn btn-outline-success">Add Product</a>
      {% endif %}
    </div>

    <form class="row g-2 align-items-end" method="get">
      <div class="col-12 col-md-5">
        <label class="form-label small text-muted mb-1">Search Products</label>
        <input type="search" name="q" value="{{ q or '' }}" class="form-control" placeholder="Search products...">
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label small text-muted mb-1">Sort By</label>
        <select name="sort" class="form-select">
          <option value="newest" {{ 'selected' if sort=='newest' else '' }}>Newest</option>
          <option value="title_asc" {{ 'selected' if sort=='title_asc' else '' }}>Title A-Z</option>
          <option value="title_desc" {{ 'selected' if sort=='title_desc' else '' }}>Title Z-A</option>
          <option value="price_asc" {{ 'selected' if sort=='price_asc' else '' }}>Price Low-High</option>
          <option value="price_desc" {{ 'selected' if sort=='price_desc' else '' }}>Price High-Low</option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <button type="submit" class="btn btn-success w-100">Apply</button>
      </div>
    </form>
  </div>

  {% if products %}
  <div class="row g-4">
    {% for p in products %}
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="card product-card h-100 overflow-hidden">
        <div class="ratio ratio-4x3 bg-light position-relative">
          {% if p.image %}
            {% if p.image.startswith('http') %}
              <img src="{{ p.image }}" class="w-100 h-100" alt="{{ p.title }}">
            {% else %}
              <img src="{{ url_for('static', filename=p.image) }}" class="w-100 h-100" alt="{{ p.title }}">
            {% endif %}
          {% else %}
            <img src="https://source.unsplash.com/600x450/?farm,agriculture,product&sig={{ p.id }}" class="w-100 h-100" alt="{{ p.title }}">
          {% endif %}
          <div class="position-absolute top-0 end-0 m-2">
            <span class="badge bg-success">New</span>
          </div>
        </div>
        <div class="card-body d-flex flex-column p-3">
          <h5 class="fw-bold mb-2">
            <a class="text-decoration-none text-dark" href="{{ url_for('ecommerce.product_detail', product_id=p.id) }}">{{ p.title }}</a>
          </h5>
          <div class="text-success fw-bold fs-5 mb-2">${{ '%.2f'|format(p.price or 0) }}</div>
          <p class="text-muted small flex-grow-1 mb-3" style="min-height: 48px;">{{ (p.description or '')[:100] }}{% if p.description and p.description|length > 100 %}...{% endif %}</p>
          <div class="d-flex justify-content-between align-items-center gap-2">
            <a href="{{ url_for('ecommerce.product_detail', product_id=p.id) }}" class="btn btn-sm btn-success">View Details</a>
            {% if p.active %}
            <form action="{{ url_for('ecommerce.add_to_cart', product_id=p.id) }}" method="POST" class="d-inline">
              <input type="hidden" name="quantity" value="1">
              <button type="submit" class="btn btn-sm btn-outline-success" title="Add to Cart">
                <i class="bi bi-cart-plus"></i>
              </button>
            </form>
            {% endif %}
            {% if is_admin %}
            <div class="d-flex gap-1">
              <a href="{{ url_for('ecommerce.edit', product_id=p.id) }}" class="btn btn-sm btn-outline-primary" title="Edit">
                <i class="bi bi-pencil"></i>
              </a>
              <form method="post" action="{{ url_for('ecommerce.delete', product_id=p.id) }}" onsubmit="return confirm('Delete this product?')" class="d-inline">
                <button class="btn btn-sm btn-outline-danger" title="Delete" type="submit">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="col-12">
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body text-center text-muted py-5">
        <i class="bi bi-inbox fs-1 d-block mb-3"></i>
        <p class="mb-0">No products available at the moment.</p>
      </div>
    </div>
  </div>
  {% endif %}

  {% if pagination %}
  <div class="d-flex justify-content-end mt-4">
    <nav>
      <ul class="pagination mb-0">
        <li class="page-item {{ 'disabled' if not pagination.has_prev else '' }}">
          <a class="page-link" href="{{ url_for('ecommerce.product_list', page=pagination.prev_num, q=q, sort=sort, per_page=per_page) }}">Prev</a>
        </li>
        {% for p in range(1, pagination.pages + 1) %}
          <li class="page-item {{ 'active' if p == pagination.page else '' }}">
            <a class="page-link" href="{{ url_for('ecommerce.product_list', page=p, q=q, sort=sort, per_page=per_page) }}">{{ p }}</a>
          </li>
        {% endfor %}
        <li class="page-item {{ 'disabled' if not pagination.has_next else '' }}">
          <a class="page-link" href="{{ url_for('ecommerce.product_list', page=pagination.next_num, q=q, sort=sort, per_page=per_page) }}">Next</a>
        </li>
      </ul>
    </nav>
  </div>
  {% endif %}
</div>
{% endblock %}

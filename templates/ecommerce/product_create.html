{% extends "base.html" %}
{% block title %}{{ 'Edit Product' if product else 'Create Product' }} - AgriFarma{% endblock %}
{% block content %}

<style>
  body {
    background: linear-gradient(135deg, #d8f3dc, #b7e4c7, #95d5b2);
    min-height: 100vh;
  }

  /* Glassy card effect */
  .product-form-card {
    border: none !important;
    border-radius: 20px !important;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .product-form-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
  }

  /* Form controls */
  .form-control, .form-select {
    border-radius: 12px;
    border: 1px solid #e9ecef;
  }

  .form-control:focus, .form-select:focus {
    border-color: #2d6a4f;
    box-shadow: 0 0 0 0.15rem rgba(45, 106, 79, 0.25);
  }

  .form-check-input:checked {
    background-color: #2d6a4f;
    border-color: #2d6a4f;
  }

  /* Buttons */
  .btn-success {
    background-color: #2d6a4f;
    border: none;
    border-radius: 12px;
    transition: all 0.3s ease;
  }

  .btn-success:hover {
    background-color: #40916c;
    transform: translateY(-2px);
  }

  .btn-outline-secondary {
    border-radius: 12px;
    transition: all 0.3s ease;
  }

  .btn-outline-secondary:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
  }

  /* Image preview */
  #previewImage {
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }

  #previewImage:hover {
    transform: scale(1.03);
  }

  /* Title styling */
  .card-header h4 {
    font-weight: 600;
    color: #2d6a4f;
    letter-spacing: 0.5px;
  }

  /* Category cards */
  .category-card {
    border-radius: 12px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }

  .category-card:hover {
    border-color: #2d6a4f;
    transform: translateY(-2px);
  }

  .category-card.selected {
    border-color: #2d6a4f;
    background-color: rgba(45, 106, 79, 0.05);
  }
</style>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="card product-form-card">
        <div class="card-header bg-transparent border-0 py-3 d-flex align-items-center justify-content-between">
          <h4 class="fw-semibold mb-0">
            <i class="bi {{ 'bi-pencil-square' if product else 'bi-plus-circle' }} me-2 text-success"></i>
            {{ 'Edit Product' if product else 'Create New Product' }}
          </h4>
          {% if product and product.image %}
          <img src="{{ url_for('static', filename=product.image) }}" alt="Preview" class="rounded-3" style="width: 60px; height: 60px; object-fit: cover;">
          {% endif %}
        </div>

        <div class="card-body px-4 py-4">
          <form method="post" enctype="multipart/form-data" novalidate id="productForm">
            
            <!-- Basic Information -->
            <div class="row mb-4">
              <div class="col-md-8">
                <div class="mb-3">
                  <label class="form-label fw-semibold"><i class="bi bi-tag-fill me-1 text-success"></i> Product Title *</label>
                  <input name="title" class="form-control" placeholder="Enter product title" value="{{ product.title if product else '' }}" required>
                  <div class="invalid-feedback">Please provide a product title.</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label fw-semibold"><i class="bi bi-currency-dollar me-1 text-success"></i> Price *</label>
                  <input name="price" type="number" step="0.01" min="0" class="form-control" placeholder="e.g. 500.00" value="{{ product.price if product else '' }}" required>
                  <div class="invalid-feedback">Please enter a valid price.</div>
                </div>
              </div>
            </div>

            <!-- Description and Specifications -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label fw-semibold"><i class="bi bi-card-text me-1 text-success"></i> Description *</label>
                  <textarea name="description" rows="6" class="form-control" placeholder="Describe your product in detail..." required>{{ product.description if product else '' }}</textarea>
                  <div class="invalid-feedback">Please enter a product description.</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label fw-semibold"><i class="bi bi-gear me-1 text-success"></i> Specifications</label>
                  <textarea name="specifications" rows="6" class="form-control" placeholder="Technical specifications, dimensions, etc.">{{ product.specifications if product else '' }}</textarea>
                </div>
              </div>
            </div>

            <!-- Category Selection -->
            <div class="mb-4">
              <label class="form-label fw-semibold"><i class="bi bi-grid me-1 text-success"></i> Category</label>
              <div class="row">
                <div class="col-md-6">
                  <select name="category" class="form-select" id="categorySelect">
                    <option value="">Select Category</option>
                    {% if categories %}
                      {% for category in categories %}
                        <option value="{{ category.id }}" {% if product and product.category_id == category.id %}selected{% endif %}>
                          {{ category.name }}
                        </option>
                      {% endfor %}
                    {% endif %}
                  </select>
                </div>
                <div class="col-md-6">
                  <select name="subcategory" class="form-select" id="subcategorySelect" disabled>
                    <option value="">Select Subcategory</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Seller Information -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label fw-semibold"><i class="bi bi-envelope me-1 text-success"></i> Contact Email</label>
                  <input name="seller_email" type="email" class="form-control" 
                         placeholder="Contact email" 
                         value="{{ product.seller_email if product else session.get('user_email', '') }}">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label fw-semibold d-block"><i class="bi bi-check2-circle me-1 text-success"></i> Status</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="active" id="activeCheck" 
                           {% if (product and product.active) or not product %}checked{% endif %}>
                    <label class="form-check-label" for="activeCheck">Active Product</label>
                  </div>
                  <small class="text-muted">Inactive products won't be visible to customers</small>
                </div>
              </div>
            </div>

            <!-- Image Upload -->
            <div class="mb-4">
              <label class="form-label fw-semibold"><i class="bi bi-image me-1 text-success"></i> Product Image</label>
              <input name="image" type="file" accept="image/*" class="form-control" id="imageInput">
              <div class="small text-muted mt-1">Upload a clear photo of your product (JPG, PNG, GIF, or WebP). Max file size: 5MB</div>
              <div class="mt-3 text-center">
                <img id="previewImage" 
                     src="{{ url_for('static', filename=product.image) if product and product.image else '' }}" 
                     class="d-none shadow-sm" 
                     style="max-width: 200px; height: 150px; object-fit: cover;">
              </div>
            </div>

            <!-- Actions -->
            <div class="d-flex justify-content-between align-items-center mt-5">
              <a href="{{ url_for('ecommerce.user_products') if product else url_for('ecommerce.product_list') }}" class="btn btn-outline-secondary px-4">
                <i class="bi bi-arrow-left me-1"></i> Cancel
              </a>
              <button class="btn btn-success px-5" type="submit">
                <i class="bi bi-save me-1"></i> {{ 'Update Product' if product else 'Create Product' }}
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS: Image Preview, Category Selection, Form Validation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const imageInput = document.getElementById('imageInput');
  const previewImage = document.getElementById('previewImage');
  const form = document.getElementById('productForm');
  const categorySelect = document.getElementById('categorySelect');
  const subcategorySelect = document.getElementById('subcategorySelect');

  // Image preview
  imageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) { // 5MB limit
        alert('File size must be less than 5MB');
        imageInput.value = '';
        return;
      }
      
      previewImage.src = URL.createObjectURL(file);
      previewImage.classList.remove('d-none');
    }
  });

  // Category/Subcategory AJAX
  categorySelect.addEventListener('change', function() {
    const categoryId = this.value;
    subcategorySelect.innerHTML = '<option value="">Loading...</option>';
    subcategorySelect.disabled = true;
    
    if (categoryId) {
      fetch(`/shop/subcategories/${categoryId}`)
        .then(response => response.json())
        .then(data => {
          subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
          data.forEach(subcategory => {
            const option = document.createElement('option');
            option.value = subcategory.id;
            option.textContent = subcategory.name;
            subcategorySelect.appendChild(option);
          });
          subcategorySelect.disabled = false;
        })
        .catch(error => {
          console.error('Error:', error);
          subcategorySelect.innerHTML = '<option value="">Error loading subcategories</option>';
        });
    } else {
      subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
      subcategorySelect.disabled = true;
    }
  });

  // Form validation
  form.addEventListener('submit', (e) => {
    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
    }
    form.classList.add('was-validated');
  });

  // Auto-populate subcategory if editing
  {% if product and product.subcategory_id %}
    categorySelect.dispatchEvent(new Event('change'));
  {% endif %}
});
</script>

{% endblock %}
